# AI 漫导 (DirectorAI) 深度完善与扩展计划

基于对当前工程代码的深度分析，本项目在核心 MVP 功能（剧本->视频）上已跑通，但要进化为商业级或"令人惊叹"的应用，需要在**工程稳健性**、**AI 表现力**、**多感官体验**、**用户体验**、**运营商业化**五个维度进行重大升级。

---

## 1. 工程稳健性升级 (Engineering Robustness)

### 1.1 跨平台视频合成引擎
*   **现状**: `VideoMergerService` 目前依赖 Android 原生 `MethodChannel` (MediaMuxer)，导致无法在 iOS/Desktop 运行。
*   **计划**: 引入 `ffmpeg_kit_flutter` (或 `ffmpeg_kit_flutter_full`)。
*   **价值**: 实现 Android/iOS/macOS/Windows 全平台视频合成，同时获得强大的滤镜、转场、字幕能力。

### 1.2 本地持久化重构
*   **现状**: 依赖 `AssetPackStorage` (基于 `SharedPreferences` 的简易存储，最多保存 10 个素材包)。
*   **计划**: 引入 `drift` (SQLite) 或 `isar` (NoSQL)。
*   **价值**: 支持更加复杂的"项目管理" (多草稿箱)、历史记录搜索、极其快速的列表加载，防止数据丢失。

### 1.3 状态管理与容错
*   **现状**: `ScreenplayController` 逻辑较重 (1040+ 行)，重试机制主要靠手动。
*   **计划**: 引入 `flutter_bloc` 或强化 `Provider` 结构，实现状态机管理（State Machine），确保断网、杀进程后能完美恢复现场 (Resumable Uploads/Generations)。

### 1.4 统一模型接入层 (Universal Model Gateway)
*   **现状**: 图像和视频生成硬编码为 Tuzi API (Gemini/Veo)，`api_service.dart` 达 92KB。
*   **计划**: 
    *   **适配器模式 (Adapter Pattern)**: 抽象出 `ImageGenerator` 和 `VideoGenerator` 接口。
    *   **多厂商支持**: 
        *   **OpenAI 兼容协议**: 支持 OneAPI, DeepSeek, 月之暗面 (Moonshot) 等。
        *   **国内大模型**: 接入阿里通义万相、百度文心一格、字节即梦 (Jimeng)。
        *   **自建服务**: 支持连接 SD WebUI / ComfyUI 本地接口。
    *   **配置管理**: 开发"模型渠道管理"界面，允许用户自定义 Base URL, Token 和 Model Name。

### 1.5 测试覆盖率提升 🆕
*   **现状**: `test/` 目录为空，无任何自动化测试。
*   **计划**:
    *   **单元测试**: 控制器业务逻辑、模型序列化/反序列化
    *   **集成测试**: API 调用链路 Mock 测试
    *   **Widget 测试**: 关键 UI 组件
*   **目标**: 核心流程 80% 测试覆盖率。

### 1.6 错误边界与崩溃监控 🆕
*   **现状**: 仅有 `AppLogger` 控制台日志。
*   **计划**:
    *   集成 Sentry 或 Firebase Crashlytics
    *   全局 `ErrorWidget.builder` 替换
    *   API 错误分类与自动重试策略

### 1.7 安全性增强 🆕
*   **现状**: API Token 依赖 `SharedPreferences` 明文存储。
*   **计划**:
    *   使用 `flutter_secure_storage` 加密存储
    *   敏感数据 (Token) 不要明文 Log
    *   请求签名机制（可选）

### 1.8 国际化 (i18n) 🆕
*   **现状**: UI 文案全部硬编码中文。
*   **计划**:
    *   ARB 文件 + `flutter_localizations`
    *   至少支持中/英双语

---

## 2. AI 表现力进化 (AI Intelligence)

### 2.1 角色一致性系统 (Character Consistency System 2.0)
*   **现状**: 依赖简单的 Prompt 描述和组合三视图 `CharacterSheet`。
*   **计划**:
    *   **角色库**: 允许用户建立"演员表"，上传或生成固定的三视图 (Character Sheet)。
    *   **Seed 控制**: 在 Tuzi API 允许的情况下，固定 Seed 以保持画风。
    *   **FaceID/LoRA**: 探索接入支持 FaceID 的模型（如 InstantID 变体），确保主角"一张脸演到底"。

### 2.2 智能导演模式 (Director Mode)
*   **现状**: GLM 一次性生成所有分镜。
*   **计划**: 引入"人机协作循环"：
    *   **分镜微调**: 用户可以点击某一张不满意的分镜，单独修改 Prompt 并重新生成 (In-painting / Re-roll)。
    *   **运镜控制**: 在此阶段让用户选择运镜方式 (Pan, Zoom, Tilt)，并注入到视频生成 Prompt 中。

### 2.3 多模型编排引擎 🆕
*   **现状**: GLM 单一决策。
*   **计划**: 引入 LangChain 风格的编排层，支持：
    *   **质量评估模型**: 自动评分生成结果
    *   **回退策略**: 主模型失败时切换备用模型
    *   **A/B 测试框架**: 对比不同模型效果

### 2.4 场景智能分割 🆕
*   **计划**: 让 GLM 输出更精细的时间轴信息
    *   场景转场类型 (淡入淡出、切换、叠化)
    *   音乐情绪标签 (作为 3.1 BGM 匹配的输入)

---

## 3. 多感官体验 (Multi-sensory Experience)

### 3.1 声音工程 (Audio Engineering)
*   **现状**: 生成的视频是静音的。
*   **计划**:
    *   **BGM 智能匹配**: 根据剧本情绪 (Happy, Sad, Epic) 自动匹配库存音乐。
    *   **TTS 配音**: 集成 `Edge-TTS` 或 `OpenAI TTS`，将剧本旁白转化为语音，对齐视频时长。
    *   **音效 (SFX)**: 识别关键字（爆炸、下雨），自动插入音效。

### 3.2 字幕系统
*   **现状**: 无字幕。
*   **计划**: 利用 FFmpeg 将旁白 (Narration) 自动烧录为底部字幕。

### 3.3 输出格式多样化 🆕
*   **计划**:
    *   抖音/快手竖屏比例 (9:16)
    *   GIF 导出（用于预览分享）
    *   分镜图组合导出（PDF/PNG）

### 3.4 片头片尾模板 🆕
*   **计划**: 提供可自定义的：
    *   开场 Logo 动画
    *   片尾字幕滚动
    *   水印叠加

---

## 4. 用户体验 (User Experience) 🆕

### 4.1 创作流程优化
*   **分步引导**: 首次使用时的新手教程
*   **模板库**: 预设热门创意模板（古风、校园、科幻等）
*   **创意启发**: 随机生成创意提示词

### 4.2 社交分享
*   **一键分享**: 集成微信/抖音分享 SDK
*   **作品集**: 云端同步用户作品
*   **社区互动**: 发现他人作品、点赞评论

### 4.3 素材库扩展
*   **内置素材**: 免费 BGM/音效库
*   **自定义素材**: 用户上传自己的背景音乐
*   **AI 音效生成**: 根据场景描述生成音效 (接入类似 ElevenLabs 的服务)

---

## 5. 运营与商业化 (Business & Operations) 🆕

### 5.1 使用统计与分析
*   **功能埋点**: 跟踪用户行为路径
*   **转化漏斗**: 分析从"创意输入"到"视频完成"的流失点

### 5.2 付费模式
*   **计费系统**: 按生成数量/质量收费
*   **会员体系**: 高级模型、更长视频、无水印等权益
*   **Token 管理**: 用户自带 API Key 模式

---

## 6. 实施路线图 (Roadmap)

### 第一阶段：基石 (The Foundation) - 4 周

#### 阶段 1A：技术债务清理 (2 周)

> ⚠️ **优先清理技术债务**，为后续功能开发打下坚实基础

| 序号 | 任务 | 目标 | 优先级 |
|------|------|------|--------|
| 1 | `api_service.dart` 拆分 | 将 92KB 文件拆分为模块化小文件 | P0 |
| 2 | `ScreenplayController` 职责分离 | 将 1040+ 行拆分为多个专职控制器 | P0 |
| 3 | `chat_screen.dart` 重构 | 将 108KB 文件拆分为组件 | P0 |
| 4 | 清理废弃代码 | 移除 `@Deprecated` 属性、注释依赖 | P1 |

#### 阶段 1B：基础设施升级 (2 周)

| 序号 | 任务 | 关联章节 | 优先级 |
|------|------|----------|--------|
| 5 | 替换视频合成引擎 → FFmpeg | 1.1 | P0 |
| 6 | 数据层重构 → SQLite/Isar | 1.2 | P0 |
| 7 | 测试框架搭建 (核心流程 80% 覆盖) | 1.5 | P1 |
| 8 | 安全存储升级 → `flutter_secure_storage` | 1.7 | P1 |

### 第二阶段：感官 (The Senses) - 4 周
| 序号 | 任务 | 关联章节 | 优先级 |
|------|------|----------|--------|
| 9 | 音频工作室 (TTS + BGM) | 3.1 | P0 |
| 10 | 字幕生成 | 3.2 | P0 |
| 11 | 输出格式多样化 (竖屏/GIF) | 3.3 | P1 |

### 第三阶段：智慧 (The Brain) - 6 周
| 序号 | 任务 | 关联章节 | 优先级 |
|------|------|----------|--------|
| 12 | 角色一致性 2.0 | 2.1 | P0 |
| 13 | 导演微调模式 | 2.2 | P0 |
| 14 | 统一模型接入层 | 1.4 | P1 |

### 第四阶段：体验 (The Experience) - 4 周
| 序号 | 任务 | 关联章节 | 优先级 |
|------|------|----------|--------|
| 15 | 创作流程优化 (新手引导、模板库) | 4.1 | P0 |
| 16 | 社交分享集成 | 4.2 | P1 |
| 17 | 国际化 (中/英双语) | 1.8 | P2 |

### 第五阶段：商业 (The Business) - 4 周
| 序号 | 任务 | 关联章节 | 优先级 |
|------|------|----------|--------|
| 18 | 使用统计与埋点 | 5.1 | P0 |
| 19 | 付费模式与会员体系 | 5.2 | P1 |
| 20 | 崩溃监控 (Sentry/Crashlytics) | 1.6 | P1 |

---

## 7. 里程碑与成功指标

| 阶段 | 里程碑 | 成功指标 |
|------|--------|----------|
| 基石 1A | 代码库可维护性提升 | 单文件 < 500 行，测试覆盖率 > 50% |
| 基石 1B | iOS 版本可运行 | FFmpeg 视频合成成功率 > 99% |
| 感官 | 有声视频发布 | 用户完播率提升 30% |
| 智慧 | 角色一致性体验改善 | 用户"重新生成"次数下降 50% |
| 体验 | 社交分享上线 | 分享率 > 10% |
| 商业 | 付费体系上线 | 付费转化率 > 2% |

---

> 💡 **建议从第一阶段 1A (技术债务清理) 开始**，清理完债务后代码库将更易维护，后续 FFmpeg 迁移和模型接入层开发会更加顺畅，以确保后续功能的稳定性。完成 FFmpeg 迁移后，应用将具备真正的跨平台能力，为后续迭代铺平道路。
